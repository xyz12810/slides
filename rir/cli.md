%title: Run It Remote - PyCon2015
%author: Shell.Xu <shell909090@gmail.com>
%date: 2015-09-06




-> Run It Remote <-

-------------------------------------------------

-> 做什么用的 <-

用将代码放到远程执行。大概就是这样子：

	scp script.py host:
	ssh host python script.py

-------------------------------------------------

-> 为什么要用rir <-

脚本的远程执行往往伴随几个困难。

目标机器在很深的内网，需要scp后再scp。
^
更新脚本内容后需要重新copy。
^
一次启动多个节点形成集群，更新代码后需要全部关闭再全部启动。
^
没有api接口。
^
一样工作，重复劳动。

-------------------------------------------------

-> Live show <-

A     B     C
\^     \^     \^
|     |     |
\\--jumpbox--/
      |
     user

-------------------------------------------------

-> rir能做什么 <-

* 本地可以将任意函数放到远程执行。
^
* 支持远程import服务端上的库。
^
  * 无缝支持py/pyc。
^
  * 只有py的情况下不需要在远程写文件，只有进程，不触发任何警报。
^
  * 动态链接库需要保证本地文件在远程可以导入（架构和依赖OK）。
^
* 支持远程打开本地文件，本地stdout/stderr。远程logging打印回本地。
^
* 支持远程回调本地函数。

-------------------------------------------------

-> 怎么做的 <-

1. ssh host python -c '...'，在远程执行一个引导代码。
   获得stdin/stdout。
^
2. 将核心脚本发送到远程执行，在importer上挂钩子，在stdout上挂钩子。
^
3. 在本地和远程交互，发送指令要求执行。

-------------------------------------------------

-> 更多细节 <-

rir支持自定义方法获取远程管道，和自定义协议和远程通讯。
目前内置的方法全是ssh家族的。

^
* 支持自定义远程启动方法。
^
  * ssh子进程 + pipe交互。
^
  * 远程可以sudo(这是自然)来获得root权限。
^
  * paramiko，无需启动子进程。
^
* 支持自定义通讯协议。
^
  * raw data。marshal + zlib。size leaded frame。
^
  * base64 coded。marshal + zlib + base64。
    支持穿越一些比较特殊的过滤设备。
^

实践中使用base64 coded模式，加上特殊的跳板机启动方案。
在七牛的集群上执行任意代码。
主要用来检查远程的漏洞修补情况。

-------------------------------------------------

-> 还有什么 <-

发挥你的想象力。
^
原则上，可以用pexpect启动一个ssh来获得远程管道。
^
连接堡垒机，模拟输入，登录到目标机器。
^
再模拟手工执行python的过程，将stdin/stdout转交给rir。
^
一切就像真人一样。
^

在远程执行任意代码，基本不会触发关键字。
^
如果不想被解出来，我们还有。。。
^
diffie-hellman key exchange algorithm + aes-256-cfb embed.
^
of cause, you will got fired.
^
but they have no evidence about what you did...

-------------------------------------------------

-> rir可以做到什么 <-

1. 在不同构的机器上执行运维脚本。
   （脚本需要是python，且在多个机器上都兼容）
^
2. 免去部署过程，测试服务端/客户端s的执行。
^
3. \*\*和\*\*\*也是很好用的，你懂。

-------------------------------------------------



-> 根本上RIR是一个远程执行框架 <-

^
你可以拿去自high

-------------------------------------------------

-> 效率呢？ <-

不算太高。在国内的用例里，每个的执行时间都到了秒级。
将一个web项目发到远程执行甚至用了2s。
^
所以，如果有大量的设备（例如上千），还是老老实实用salt比较实在。
^
但是对一次性应用来说，几秒的时间完全不痛不痒。

-------------------------------------------------

-> 内附脚本 <-

hwinfo: 收集远程机器的各种数据。
sync: 同步远程文件。

-------------------------------------------------

-> sync? <-

没错。sync又是一个非常复杂的小系统。

^
使用yaml作为配置和数据存储。
^
定义远程的一组特定目录。
^
从远程同步文件内容和属性/属主到本地。
^
只同步需要更新的，相同内容不需要通过网络。
^
从本地同步文件内容和属性/属主到远程。

-------------------------------------------------

-> 所以呢？sync是做什么的？ <-

例如你有20台机器，家里有几台，自己有几台，帮朋友管几台。
每个系统都不一样，配置各自不一样。你打算如何管理配置？
^
sync可以将远程配置和属性批量拉到本地，再提交到git里。
^
支持多人对同样的机器组进行协作更新。merge配置，pull，push。。。
^
你们懂。
^
反正push到机器上的时候不要一起来就行。

-------------------------------------------------

-> Live show <-

-------------------------------------------------

-> 效率呢？ <-

7台内网机器+2台国内物理机。
^
1.5s。
^
其实一台机器同步一些配置文件下来并不需要多久。
只要你的机器能并发执行。。。

-------------------------------------------------

-> License <-

Run It Remote: BSD-3-clause
This slide: cc-by-sa3.0

^
Powered by [MDP](https://github.com/visit1985/mdp)
GPLv3

-------------------------------------------------




-> Q&A <-
